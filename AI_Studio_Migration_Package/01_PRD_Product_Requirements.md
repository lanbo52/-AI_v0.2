# 产品需求文档 (PRD) - CinemaForge v0.2

## 1. 产品概述
**CinemaForge** 是一款 **AI 驱动的沉浸式短剧剧本创作与分镜生成系统**。
它旨在通过多智能体协作（Multi-Agent Collaboration），引导创作者完成从灵感构思、世界观设定、人设开发、大纲规划到标准剧本写作及可视化分镜生成的全流程。

### 1.1 核心价值/目标
*   **结构化引导**：防止创作过程中的发散，强制遵循 灵感 -> 世界观 -> 人设 -> 大纲 -> 剧本 的行业通认流程。
*   **质量守门**：引入专门的 "Aligner (质检员)" Agent，确保每一阶段的产出符合前序设定（如剧本台词必须符合人设，大纲情节必须符合世界观逻辑）。
*   **自动化可视化**：将文字剧本自动转化为分镜列表，并生成用于 AI 绘图/视频生成的提示词。
*   **沉浸式体验**：提供左右分屏的工作区，左侧为 AI 助手，右侧为所见即所得的编辑器。

## 2. 用户角色
*   **短剧编剧**：主要用户。需要高效地将创意转化为标准格式的剧本，并确保逻辑自洽。
*   **分镜导演/统筹**：需要将剧本拆解为可拍摄的镜头表，并指导后期制作。

## 3. 核心业务流程 (The Creative Flow)

系统采用 **严格的线性阶段锁 (Stag-Gated Workflow)**：
1.  **Idea (创意)**: 确定故事核心梗概。
2.  **World (世界观)**: 输出 `world.md`。定义时间、地点、规则。
3.  **Characters (人设)**: 输出 `characters.md`。定义男女主性格、动机。
4.  **Outline (大纲)**: 输出 `outline.md`。定义分集剧情、钩子。
5.  **Production (制作)**: 输出 `episodes/EP-xx.md` 及其对应的可视化分镜。

**关键规则**：
*   **前置依赖**：用户必须完成上一阶段并 **通过质检**，才能解锁下一阶段。
*   **自动质检**：每次用户保存内容时，系统会自动触发 Aligner Agent 进行一致性检查。
*   **自动修复**：如果质检失败，Auto-Fix Agent 会尝试自动修复文本中的逻辑漏洞。

## 4. 功能模块详述

### 4.1 项目管理 (Project Manager)
*   **项目列表**：卡片式展示所有项目，显示最后更新时间。
*   **新建项目**：输入项目名称和简介即可创建。
*   **本地存储**：使用 IndexedDB (Dexie.js) 进行数据持久化，支持大量文本和自动保存。

### 4.2 创作工作台 (Workspace)
*   **双栏布局**：
    *   **左侧：AI 助手 (Assistant)** - 聊天界面，提供引导、建议和反馈。
    *   **右侧：编辑器 (Editor)** - Markdown 编辑器，支持实时预览和格式化。
*   **阶段导航 (Stage Navigation)**：顶部导航栏，显示当前所处阶段（World > Characters > Outline > Production）。未解锁阶段不可点击。

### 4.3 AI 助手 (Agent Interaction)
*   **Writer Agent**：主对话对象。
    *   主动引导用户完善设定。
    *   生成草稿（Draft）供用户确认。
    *   **交互规范**：Draft -> Question (询问意见) -> User Confirm -> Save (正式提交)。
*   **Activity Card (状态卡片)**：
    *   实时显示 Agent 当前在做什么（如 "正在撰写世界观...", "正在进行一致性检查..."）。
    *   显示操作日志和结果（Pass/Fail）。
*   **自动应用**：聊天中生成的代码块/文本块支持一键 "插入编辑器"。

### 4.4 制作模式 (Production Mode)
*   **剧集管理**：显示剧集列表 (EP-01, EP-02...)，支持新增剧集。
*   **左右分屏创作**：
    *   左侧：剧本编辑器。
    *   右侧：分镜预览区 (Storyboard)。
*   **一键导演 (Run Director)**：
    *   点击按钮，Director Agent 分析当前剧本。
    *   自动拆解出 Scene (场) 和 Shot (镜)。
    *   Visualizer Agent 自动为每个镜头生成 MJ/SD 提示词。
    *   Motion Agent 自动生成 Runway/Pika 运镜提示词。

### 4.5 设置 (Settings)
*   **模型配置**：支持配置 OpenAI 兼容接口（如 DeepSeek, Nvidia NIM 等）。
*   **API Key 管理**：安全存储 Key。

## 5. 这里是重点：Agent 协作逻辑
这是复现系统的关键。系统不仅仅是一个 Chatbot，而是一组分工明确的 Agent：

| Agent | 职责 | 触发时机 |
| :--- | :--- | :--- |
| **Writer** | 交互、引导、生成草案 | 用户在聊天框输入时 |
| **Aligner** | 质量检查、逻辑一致性校验 | 用户点击保存或 Writer 提交保存请求时 |
| **Auto Fixer** | 根据 Aligner 反馈自动修复内容 | 当 Aligner 报错且开启自动修复时 |
| **Director** | 剧本 -> 分镜拆解 (JSON) | 用户点击 "生成分镜" 时 |
| **Visualizer** | 分镜 -> 画面提示词 | Director 拆解完成后自动触发 |
| **Motion** | 分镜 -> 视频运镜提示词 | Director 拆解完成后自动触发 |

## 6. 非功能需求
*   **响应式**：界面需适应不同宽度的屏幕，侧边栏可拖拽调整宽度。
*   **流式响应**：AI 回复必须支持 Stream，避免长等待。
*   **错误处理**：网络错误或 Token 超限需有优雅提示。
*   **数据安全**：所有 Key 存储在本地 localStorage/IndexedDB，不上传服务器。
